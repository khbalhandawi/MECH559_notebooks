\documentclass[11pt]{article}

    \usepackage[breakable]{tcolorbox}
    \usepackage{parskip} % Stop auto-indenting (to mimic markdown behaviour)
    

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % Maintain compatibility with old templates. Remove in nbconvert 6.0
    \let\Oldincludegraphics\includegraphics
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionFormat{nocaption}{}
    \captionsetup{format=nocaption,aboveskip=0pt,belowskip=0pt}

    \usepackage{float}
    \floatplacement{figure}{H} % forces figures to be placed at the correct location
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro

    \usepackage{iftex}
    \ifPDFTeX
        \usepackage[T1]{fontenc}
        \IfFileExists{alphabeta.sty}{
              \usepackage{alphabeta}
          }{
              \usepackage[mathletters]{ucs}
              \usepackage[utf8x]{inputenc}
          }
    \else
        \usepackage{fontspec}
        \usepackage{unicode-math}
    \fi

    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics
                         % to support a larger range
    \makeatletter % fix for old versions of grffile with XeLaTeX
    \@ifpackagelater{grffile}{2019/11/01}
    {
      % Do nothing on new versions
    }
    {
      \def\Gread@@xetex#1{%
        \IfFileExists{"\Gin@base".bb}%
        {\Gread@eps{\Gin@base.bb}}%
        {\Gread@@xetex@aux#1}%
      }
    }
    \makeatother
    \usepackage[Export]{adjustbox} % Used to constrain images to a maximum size
    \adjustboxset{max size={0.9\linewidth}{0.9\paperheight}}

    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    % The default LaTeX title has an obnoxious amount of whitespace. By default,
    % titling removes some of it. It also provides customization options.
    \usepackage{titling}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage{array}     % table support for pandoc >= 2.11.3
    \usepackage{calc}      % table minipage width calculation for pandoc >= 2.11.1
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    \usepackage{mathrsfs}
    

    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}
    \definecolor{ansi-default-inverse-fg}{HTML}{FFFFFF}
    \definecolor{ansi-default-inverse-bg}{HTML}{000000}

    % common color for the border for error outputs.
    \definecolor{outerrorbackground}{HTML}{FFDFDF}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}

    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}


    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatibility definitions
    \def\gt{>}
    \def\lt{<}
    \let\Oldtex\TeX
    \let\Oldlatex\LaTeX
    \renewcommand{\TeX}{\textrm{\Oldtex}}
    \renewcommand{\LaTeX}{\textrm{\Oldlatex}}
    % Document parameters
    % Document title
    \title{mdo\_intro}
    
    
    
    
    
% Pygments definitions
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\@namedef{PY@tok@w}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\@namedef{PY@tok@c}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}
\@namedef{PY@tok@cp}{\def\PY@tc##1{\textcolor[rgb]{0.61,0.40,0.00}{##1}}}
\@namedef{PY@tok@k}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@kp}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@kt}{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\@namedef{PY@tok@o}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@ow}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\@namedef{PY@tok@nb}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@nf}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\@namedef{PY@tok@nc}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\@namedef{PY@tok@nn}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\@namedef{PY@tok@ne}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.80,0.25,0.22}{##1}}}
\@namedef{PY@tok@nv}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@no}{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\@namedef{PY@tok@nl}{\def\PY@tc##1{\textcolor[rgb]{0.46,0.46,0.00}{##1}}}
\@namedef{PY@tok@ni}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.44,0.44,0.44}{##1}}}
\@namedef{PY@tok@na}{\def\PY@tc##1{\textcolor[rgb]{0.41,0.47,0.13}{##1}}}
\@namedef{PY@tok@nt}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@nd}{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\@namedef{PY@tok@s}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@sd}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@si}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.64,0.35,0.47}{##1}}}
\@namedef{PY@tok@se}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.36,0.12}{##1}}}
\@namedef{PY@tok@sr}{\def\PY@tc##1{\textcolor[rgb]{0.64,0.35,0.47}{##1}}}
\@namedef{PY@tok@ss}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@sx}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@m}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@gh}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\@namedef{PY@tok@gu}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\@namedef{PY@tok@gd}{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\@namedef{PY@tok@gi}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.52,0.00}{##1}}}
\@namedef{PY@tok@gr}{\def\PY@tc##1{\textcolor[rgb]{0.89,0.00,0.00}{##1}}}
\@namedef{PY@tok@ge}{\let\PY@it=\textit}
\@namedef{PY@tok@gs}{\let\PY@bf=\textbf}
\@namedef{PY@tok@gp}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\@namedef{PY@tok@go}{\def\PY@tc##1{\textcolor[rgb]{0.44,0.44,0.44}{##1}}}
\@namedef{PY@tok@gt}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\@namedef{PY@tok@err}{\def\PY@bc##1{{\setlength{\fboxsep}{\string -\fboxrule}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}}
\@namedef{PY@tok@kc}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@kd}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@kn}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@kr}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@bp}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@fm}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\@namedef{PY@tok@vc}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@vg}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@vi}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@vm}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@sa}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@sb}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@sc}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@dl}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@s2}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@sh}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@s1}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@mb}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@mf}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@mh}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@mi}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@il}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@mo}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@ch}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}
\@namedef{PY@tok@cm}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}
\@namedef{PY@tok@cpf}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}
\@namedef{PY@tok@c1}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}
\@namedef{PY@tok@cs}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % For linebreaks inside Verbatim environment from package fancyvrb.
    \makeatletter
        \newbox\Wrappedcontinuationbox
        \newbox\Wrappedvisiblespacebox
        \newcommand*\Wrappedvisiblespace {\textcolor{red}{\textvisiblespace}}
        \newcommand*\Wrappedcontinuationsymbol {\textcolor{red}{\llap{\tiny$\m@th\hookrightarrow$}}}
        \newcommand*\Wrappedcontinuationindent {3ex }
        \newcommand*\Wrappedafterbreak {\kern\Wrappedcontinuationindent\copy\Wrappedcontinuationbox}
        % Take advantage of the already applied Pygments mark-up to insert
        % potential linebreaks for TeX processing.
        %        {, <, #, %, $, ' and ": go to next line.
        %        _, }, ^, &, >, - and ~: stay at end of broken line.
        % Use of \textquotesingle for straight quote.
        \newcommand*\Wrappedbreaksatspecials {%
            \def\PYGZus{\discretionary{\char`\_}{\Wrappedafterbreak}{\char`\_}}%
            \def\PYGZob{\discretionary{}{\Wrappedafterbreak\char`\{}{\char`\{}}%
            \def\PYGZcb{\discretionary{\char`\}}{\Wrappedafterbreak}{\char`\}}}%
            \def\PYGZca{\discretionary{\char`\^}{\Wrappedafterbreak}{\char`\^}}%
            \def\PYGZam{\discretionary{\char`\&}{\Wrappedafterbreak}{\char`\&}}%
            \def\PYGZlt{\discretionary{}{\Wrappedafterbreak\char`\<}{\char`\<}}%
            \def\PYGZgt{\discretionary{\char`\>}{\Wrappedafterbreak}{\char`\>}}%
            \def\PYGZsh{\discretionary{}{\Wrappedafterbreak\char`\#}{\char`\#}}%
            \def\PYGZpc{\discretionary{}{\Wrappedafterbreak\char`\%}{\char`\%}}%
            \def\PYGZdl{\discretionary{}{\Wrappedafterbreak\char`\$}{\char`\$}}%
            \def\PYGZhy{\discretionary{\char`\-}{\Wrappedafterbreak}{\char`\-}}%
            \def\PYGZsq{\discretionary{}{\Wrappedafterbreak\textquotesingle}{\textquotesingle}}%
            \def\PYGZdq{\discretionary{}{\Wrappedafterbreak\char`\"}{\char`\"}}%
            \def\PYGZti{\discretionary{\char`\~}{\Wrappedafterbreak}{\char`\~}}%
        }
        % Some characters . , ; ? ! / are not pygmentized.
        % This macro makes them "active" and they will insert potential linebreaks
        \newcommand*\Wrappedbreaksatpunct {%
            \lccode`\~`\.\lowercase{\def~}{\discretionary{\hbox{\char`\.}}{\Wrappedafterbreak}{\hbox{\char`\.}}}%
            \lccode`\~`\,\lowercase{\def~}{\discretionary{\hbox{\char`\,}}{\Wrappedafterbreak}{\hbox{\char`\,}}}%
            \lccode`\~`\;\lowercase{\def~}{\discretionary{\hbox{\char`\;}}{\Wrappedafterbreak}{\hbox{\char`\;}}}%
            \lccode`\~`\:\lowercase{\def~}{\discretionary{\hbox{\char`\:}}{\Wrappedafterbreak}{\hbox{\char`\:}}}%
            \lccode`\~`\?\lowercase{\def~}{\discretionary{\hbox{\char`\?}}{\Wrappedafterbreak}{\hbox{\char`\?}}}%
            \lccode`\~`\!\lowercase{\def~}{\discretionary{\hbox{\char`\!}}{\Wrappedafterbreak}{\hbox{\char`\!}}}%
            \lccode`\~`\/\lowercase{\def~}{\discretionary{\hbox{\char`\/}}{\Wrappedafterbreak}{\hbox{\char`\/}}}%
            \catcode`\.\active
            \catcode`\,\active
            \catcode`\;\active
            \catcode`\:\active
            \catcode`\?\active
            \catcode`\!\active
            \catcode`\/\active
            \lccode`\~`\~
        }
    \makeatother

    \let\OriginalVerbatim=\Verbatim
    \makeatletter
    \renewcommand{\Verbatim}[1][1]{%
        %\parskip\z@skip
        \sbox\Wrappedcontinuationbox {\Wrappedcontinuationsymbol}%
        \sbox\Wrappedvisiblespacebox {\FV@SetupFont\Wrappedvisiblespace}%
        \def\FancyVerbFormatLine ##1{\hsize\linewidth
            \vtop{\raggedright\hyphenpenalty\z@\exhyphenpenalty\z@
                \doublehyphendemerits\z@\finalhyphendemerits\z@
                \strut ##1\strut}%
        }%
        % If the linebreak is at a space, the latter will be displayed as visible
        % space at end of first line, and a continuation symbol starts next line.
        % Stretch/shrink are however usually zero for typewriter font.
        \def\FV@Space {%
            \nobreak\hskip\z@ plus\fontdimen3\font minus\fontdimen4\font
            \discretionary{\copy\Wrappedvisiblespacebox}{\Wrappedafterbreak}
            {\kern\fontdimen2\font}%
        }%

        % Allow breaks at special characters using \PYG... macros.
        \Wrappedbreaksatspecials
        % Breaks at punctuation characters . , ; ? ! and / need catcode=\active
        \OriginalVerbatim[#1,codes*=\Wrappedbreaksatpunct]%
    }
    \makeatother

    % Exact colors from NB
    \definecolor{incolor}{HTML}{303F9F}
    \definecolor{outcolor}{HTML}{D84315}
    \definecolor{cellborder}{HTML}{CFCFCF}
    \definecolor{cellbackground}{HTML}{F7F7F7}

    % prompt
    \makeatletter
    \newcommand{\boxspacing}{\kern\kvtcb@left@rule\kern\kvtcb@boxsep}
    \makeatother
    \newcommand{\prompt}[4]{
        {\ttfamily\llap{{\color{#2}[#3]:\hspace{3pt}#4}}\vspace{-\baselineskip}}
    }
    

    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

\begin{document}
    
    \maketitle
    
    

    
    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{1}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
\end{Verbatim}
\end{tcolorbox}

    \hypertarget{intro-to-multidisciplinary-analysis-mda}{%
\section{Intro to multidisciplinary analysis
(MDA)}\label{intro-to-multidisciplinary-analysis-mda}}

The motivation for multidisciplinary design optimization (MDO) comes
from the large number of multidisciplinary analyses (MDAs) that are
common in engineering. The most famous MDA in engineering is the
aero-structural analysis problem. We will illustrate using the example
of a wing subject to aero-structural loads. The aerodynamic forces
deflect the wing which changes its shape, which in turn changes the
aerodynamic behaviour of the wing.

We will look at a simplified example of a wing modeled as a cantilever
beam, made of Euler-Bernoulli beam sections, subject to aerodynamic
forces.

\hypertarget{illustrative-example-structure-fluids-interaction-problem}{%
\subsection{Illustrative example: Structure-fluids interaction
problem}\label{illustrative-example-structure-fluids-interaction-problem}}

\begin{longtable}[]{@{}c@{}}
\toprule
\endhead
\begin{minipage}[t]{0.97\columnwidth}\centering
    \begin{figure}
        \centering
        \includegraphics[height=5cm]{wing_structure_fluid.pdf}
    \end{figure}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.97\columnwidth}\centering
Fig.0 Aerostructural wing model showing the aerodynamic state variables
(circulations \(\Gamma\)) on the left and structural state variables
(displacements \(\mathbf{d}_z\) and rotations \(\mathbf{d}_\theta\)) on
the right.\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.97\columnwidth}\centering
\emph{From Martins and Ning}\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{structural-analysis}{%
\subsubsection{Structural Analysis}\label{structural-analysis}}

Structural analysis can be performed using finite element software to
solve for the structural displacements \(\mathbf{d}\) given some
boundary conditions such as forces \(\mathbf{q}\). These forces may come
from an aerodynamic analysis and are related to the computational fluid
dynamics state variables \(\hat{\Gamma}\). In this example,
\(\hat{\Gamma}\) is the circulation vortex strength on a wing. The hat
denotes that these values are estimates of the state variables when the
analysis has converged.

\begin{equation}
K\mathbf{d} - \mathbf{q}(\hat{\Gamma}) = \mathbf{0}
\tag{1}
\end{equation}

Solving the above equation is done by specialized finite element
software and returns a solution \({\mathbf{d}}\) that estimates the
displacements. In other words, the FEA program can be thought of as a
function \(\mathcal{U}_1(\hat{\Gamma})\) that returns the displacements
\({\mathbf{d}}\) given some aerodynamic forces
\(\mathbf{q}(\hat{\Gamma})\).

The residual for this discipline becomes
\(r_1(\hat{\mathbf{d}};\hat{\mathbf{q}}) = \hat{\mathbf{d}} - \mathcal{U}_1(\hat{\Gamma}) = \hat{\mathbf{d}} - {\mathbf{d}} = \mathbf{0}\)
and solving it returns an estimate of displacements that will cause the
analysis to converge \(\hat{\mathbf{d}}\). These estimates will be
passed back to the aerodynamic analysis.

\hypertarget{aerodynamic-analysis}{%
\subsubsection{Aerodynamic Analysis}\label{aerodynamic-analysis}}

The aerodynamic analysis involves solving the following system of
equations using computational fluid dynamics (CFD).

\begin{equation}
A(\hat{\mathbf{d}})\Gamma - \mathbf{v}(\hat{\mathbf{d}}) = \mathbf{0}
\tag{2}
\end{equation}

where \(\Gamma\) is the state vector we want to solve for representing
the circulation vortex strength. \(\mathbf{v}\) is a vector of boundary
conditions (similar to the vector of applied loads \(\mathbf{q}\) in the
structural analysis). \(A\) is the matrix of aerodynamic influence
coefficients (similar to the global stiffness matrix \(K\) from the
structural analysis). However, unlike \(K\), \(A\) depends on the shape
of the wing which in turn depends on the displacements estimated by the
structural analysis \(\hat{\mathbf{d}}\).

The residual for this discipline becomes
\(r_2(\hat{\Gamma};\hat{\mathbf{d}}) = \hat{\Gamma} - \mathcal{U}_2(\hat{\mathbf{d}}) = \hat{\Gamma} - {\Gamma} = \mathbf{0}\),
where \(\mathcal{U}_2(\hat{\mathbf{d}})\) involves solving Equation (2)
for the circulation vortex strength \(\Gamma\).

The estimate \(\hat{\Gamma}\) is passed back to the aerodynamic
analysis. The previous analysis can be described by the diagram below.

\begin{longtable}[]{@{}c@{}}
\toprule
\endhead
\begin{minipage}[t]{0.97\columnwidth}\centering
    \begin{figure}
        \centering
        \includegraphics[width=0.9\textwidth]{images/MDA_diagram_aero.png}
    \end{figure}\strut
\end{minipage}\tabularnewline
Fig.1 Aerostructural multidisciplinary analysis (MDA)
diagram.\tabularnewline
\bottomrule
\end{longtable}

The XDSM for the aforementioned aero-structural analysis problem is
shown below:

The XDSM for aerostructural example looks like this:

\begin{longtable}[]{@{}c@{}}
\toprule
\endhead
\begin{minipage}[t]{0.97\columnwidth}\centering
    \begin{figure}
        \centering
        \includegraphics[height=6cm]{aerostructural.pdf}
    \end{figure}\strut
\end{minipage}\tabularnewline
Fig.2 XDSM for Aerostructural multidisciplinary analysis
(MDA).\tabularnewline
\bottomrule
\end{longtable}

    \hypertarget{numerical-mda-example}{%
\subsection{Numerical MDA example}\label{numerical-mda-example}}

Consider the following coupled optimization problem

\begin{equation*}
    \begin{aligned}
        & \underset{\mathbf{x} = \left[u,v,w\right]^\mathrm{T}}{\text{minimize}}
        & & f(u,v;a,b) = u+v+a+b\\
        & \text{subject to}
        & & g(w;b) = w + b -10 \leq 0\\
        & & & 0 \leq u,v,w \leq 10\\
        & \text{while solving}
        & & r_1(a;b) = a - \left(\log(u) + \log(v) + \log(b)\right) = 0\\
        & & & r_2(b;a) = b - \left(u^{-1} + w^{-1} + a^{-1}\right) = 0\\
        & \text{for a given $u$, $v$, and $w$}
    \end{aligned}
    \tag{3}
\end{equation*}

Solving for the state variables \(a\) and \(b\) involves solving the set
of equations below. Equation (4) is an example of an MDA (just like the
aerostructural problem earlier):

\begin{equation*}
    \begin{aligned}
        & r_1(a;b) = a - \left(\log(u) + \log(v) + \log(b)\right) = 0\\
        & r_2(b;a) = b - \left(u^{-1} + w^{-1} + a^{-1}\right) = 0\\
    \end{aligned}
    \tag{4}
\end{equation*}

which cannot be solved explicitly. To prove this, Let us try to find an
explicit expression for \(a\) in terms of \(b\).

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{2}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k+kn}{import} \PY{n+nn}{sympy} \PY{k}{as} \PY{n+nn}{sym}
\PY{k+kn}{from} \PY{n+nn}{sympy} \PY{k+kn}{import} \PY{n}{pprint}\PY{p}{,} \PY{n}{latex}\PY{p}{,} \PY{n}{root}
\PY{k+kn}{from} \PY{n+nn}{IPython}\PY{n+nn}{.}\PY{n+nn}{display} \PY{k+kn}{import} \PY{n}{display}\PY{p}{,} \PY{n}{Latex}

\PY{n}{a} \PY{o}{=} \PY{n}{sym}\PY{o}{.}\PY{n}{Symbol}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{a}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{b} \PY{o}{=} \PY{n}{sym}\PY{o}{.}\PY{n}{Symbol}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{b}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{u} \PY{o}{=} \PY{n}{sym}\PY{o}{.}\PY{n}{Symbol}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{u}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{v} \PY{o}{=} \PY{n}{sym}\PY{o}{.}\PY{n}{Symbol}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{v}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{w} \PY{o}{=} \PY{n}{sym}\PY{o}{.}\PY{n}{Symbol}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{w}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}

\PY{n}{r1} \PY{o}{=} \PY{n}{a} \PY{o}{\PYZhy{}} \PY{n}{sym}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{u}\PY{p}{)} \PY{o}{\PYZhy{}} \PY{n}{sym}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{v}\PY{p}{)} \PY{o}{\PYZhy{}} \PY{n}{sym}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{b}\PY{p}{)}
\PY{n}{r2} \PY{o}{=} \PY{n}{b} \PY{o}{\PYZhy{}} \PY{l+m+mi}{1}\PY{o}{/}\PY{n}{u} \PY{o}{\PYZhy{}} \PY{l+m+mi}{1}\PY{o}{/}\PY{n}{w}  \PY{o}{\PYZhy{}} \PY{l+m+mi}{1}\PY{o}{/}\PY{n}{a}

\PY{n}{eq1} \PY{o}{=} \PY{n}{a} \PY{o}{\PYZhy{}} \PY{n}{sym}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{u}\PY{p}{)} \PY{o}{\PYZhy{}} \PY{n}{sym}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{v}\PY{p}{)} \PY{o}{\PYZhy{}} \PY{n}{sym}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{/}\PY{n}{u} \PY{o}{+} \PY{l+m+mi}{1}\PY{o}{/}\PY{n}{w}  \PY{o}{+} \PY{l+m+mi}{1}\PY{o}{/}\PY{n}{a}\PY{p}{)}
\PY{c+c1}{\PYZsh{} sym.solve(eq1,a) \PYZsh{} trying to solve for a explicitly will result in an error!}
\end{Verbatim}
\end{tcolorbox}

    Instead, we focus on solving for \(a\) and \(b\) such that the residuals
\(r_1=0\) and \(r_2=0\) iteratively using a Multidisciplinary Analysis
(MDA) for a fixed value of \(u\), \(v\), and \(w\). First let us
slightly change the notation of the governing equations:

\begin{align*}
    & r_1(\hat{a};\hat{b}) = \hat{a} - \mathcal{U}_1(\hat{b}) = 0\\
    & r_2(\hat{b};\hat{a}) = \hat{b} - \mathcal{U}_2(\hat{a}) = 0\\
\end{align*}

\(\mathcal{U}_1(\hat{b})\) and \(\mathcal{U}_2(\hat{a})\) are considered
the discipline solvers and could represent the FEA and CFD programs in
the aerostructural problem.

    \hypertarget{the-nonlinear-block-gaussseidel-and-block-jacobi-mda-algorithms}{%
\subsection{The Nonlinear block Gauss--Seidel and block Jacobi MDA
algorithms}\label{the-nonlinear-block-gaussseidel-and-block-jacobi-mda-algorithms}}

The MDA approach we will use is called the \emph{block Gauss--Seidel
algorithm} and has an XDSM similar to that of the aerostructural
problem. 1) Starting with an initial guess for \(\hat{a}\) and
\(\hat{b}\), \(\hat{a}^{(0)}\) and \(\hat{b}^{(0)}\), respectively, 2)
we solve discipline 1 for \(\hat{a}\). 3) We feed \(\hat{a}\) into
discipline 2, 4) and then solve for \(\hat{b}\) and then go back to step
2.

We repeat the above process until
\(\hat{a}_\mathrm{new} - \hat{a}_\mathrm{old} \leq \varepsilon\), where
\(\varepsilon\) is some tolerance. We can also solve for \(\hat{a}\) and
\(\hat{b}\) simultaneously rather than serially resulting in the block
Jacobi MDA.

The XDSM for the above MDAs is shown below:

\begin{longtable}[]{@{}c@{}}
\toprule
\endhead
\begin{minipage}[t]{0.97\columnwidth}\centering
    \begin{figure}
        \centering
        \includegraphics[width=0.7\textwidth]{gauss.pdf}
    \end{figure}
    \begin{figure}
        \centering
        \includegraphics[width=0.7\textwidth]{gauss.pdf}
    \end{figure}
\end{minipage}\tabularnewline
Fig.3 block Gauss--Seidel and Block Jacobi MDAs.\tabularnewline
\bottomrule
\end{longtable}

This algorithm is implemented below in Python.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{3}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} these are your coupled disciplines}
\PY{n}{U1} \PY{o}{=} \PY{k}{lambda} \PY{n}{uj}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{u}\PY{p}{)} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{v}\PY{p}{)} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{uj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}
\PY{n}{U2} \PY{o}{=} \PY{k}{lambda} \PY{n}{uj}\PY{p}{:} \PY{l+m+mi}{1}\PY{o}{/}\PY{n}{u} \PY{o}{+} \PY{l+m+mi}{1}\PY{o}{/}\PY{n}{w} \PY{o}{+} \PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{uj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}

\PY{n}{u} \PY{o}{=} \PY{l+m+mi}{1}
\PY{n}{v} \PY{o}{=} \PY{l+m+mi}{1}
\PY{n}{w} \PY{o}{=} \PY{l+m+mi}{1}
\PY{n}{a0}\PY{o}{=}\PY{l+m+mi}{1}
\PY{n}{b0}\PY{o}{=}\PY{l+m+mi}{1}
\PY{n}{uk} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{a0}\PY{p}{,}\PY{n}{b0}\PY{p}{]}\PY{p}{)}
\PY{n}{k} \PY{o}{=} \PY{l+m+mi}{0}
\PY{n}{e} \PY{o}{=} \PY{l+m+mf}{1e\PYZhy{}6}
\PY{n}{disciplines} \PY{o}{=} \PY{p}{[}\PY{n}{U1}\PY{p}{,}\PY{n}{U2}\PY{p}{]}

\PY{k}{while} \PY{k+kc}{True}\PY{p}{:}
    \PY{n}{uk\PYZus{}old} \PY{o}{=} \PY{n}{uk}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{p}{)}
    \PY{k}{for} \PY{n}{i}\PY{p}{,}\PY{n}{discipline} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{disciplines}\PY{p}{)}\PY{p}{:}
        \PY{n}{mask} \PY{o}{=} \PY{p}{[}\PY{k+kc}{True}\PY{p}{,}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{disciplines}\PY{p}{)}
        \PY{n}{mask}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{k+kc}{False} \PY{c+c1}{\PYZsh{} select all state variables except the current one (u\PYZus{}i)}
        \PY{n}{uk}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{discipline}\PY{p}{(}\PY{n}{uk}\PY{p}{[}\PY{n}{mask}\PY{p}{]}\PY{p}{)}
    \PY{k}{if} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{uk} \PY{o}{\PYZhy{}} \PY{n}{uk\PYZus{}old}\PY{p}{)} \PY{o}{\PYZlt{}}\PY{o}{=} \PY{n}{e} \PY{o+ow}{or} \PY{n}{k} \PY{o}{\PYZgt{}} \PY{l+m+mi}{10}\PY{p}{:}
        \PY{k}{break}
    \PY{n}{k}\PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
    \PY{n+nb}{print}\PY{p}{(}\PY{n}{uk}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
[      0 1000002]
[13  2]
[      0 1000002]
[13  2]
[      0 1000002]
[13  2]
[      0 1000002]
[13  2]
[      0 1000002]
[13  2]
[      0 1000002]
    \end{Verbatim}

    We can see that the previous algorithm did not converge. It started to
oscillate. We can use an alternative algorithm that is based on the
Newton-Raphson scheme to handle the coupling between the disciplines.

    \hypertarget{the-reduced-space-hierarchical-newton-solver}{%
\subsection{The reduced-space hierarchical Newton
solver}\label{the-reduced-space-hierarchical-newton-solver}}

This algorithm is unequivocally also called \emph{Newton's Method}. As
with the Newton-Raphson algorithm, it requires derivative information to
find the state variables \(\hat{a}\) and \(\hat{b}\) at which
convergence occurs. The algorithm goes something like this:

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\tightlist
\item
  Starting with an initial guess for \(\hat{a}\) and \(\hat{b}\),
  \(\hat{a}^{(0)}\) and \(\hat{b}^{(0)}\), respectively,
\item
  we solve discipline 1 for \(\hat{a}\). We also find the gradient of
  the discipline analysis \(\mathcal{U}(\hat{b})\) with respect to
  \(\hat{b}\). In other words,
  \(\dfrac{\partial\mathcal{U}_1}{\partial\hat{b}}\) (all state
  variables except \(\hat{a}\))
\item
  In parallel, we solve discipline 2 for \(\hat{b}\). We also find the
  gradient with respect to \(\hat{a}\),
  \(\dfrac{\partial\mathcal{U}_2}{\partial\hat{b}}\) (all state
  variables except \(\hat{b}\))
\item
  We solve the following system of equations for \(\Delta\hat{a}\) and
  \(\Delta\hat{b}\): \[
  \begin{bmatrix}
   1       & \left.\dfrac{\partial\mathcal{U}_1}{\partial\hat{b}}\right|_{\hat{b}}  \\
   \left.\dfrac{\partial\mathcal{U}_2}{\partial\hat{a}}\right|_{\hat{a}}        & 1  \\
  \end{bmatrix}
  \begin{bmatrix}
   \Delta\hat{a}\\
   \Delta\hat{b}\\
  \end{bmatrix} = -
  \begin{bmatrix}
   \hat{a} - \mathcal{U}_1(\hat{b})\\
   \hat{b} - \mathcal{U}_2(\hat{a})\\
  \end{bmatrix}
  \]
\item
  we update \(\hat{a}\) and \(\hat{b}\) according to
  \(\hat{a} \gets \hat{a} + \Delta\hat{a}\) and
  \(\hat{a} \gets \hat{a} + \Delta\hat{a}\), respectively and go back to
  step 2.
\end{enumerate}

The XDSM for the above MDA is shown below:

\begin{longtable}[]{@{}c@{}}
\toprule
\endhead
\begin{minipage}[t]{0.97\columnwidth}\centering
    \begin{figure}
        \centering
        \includegraphics[width=0.9\textwidth]{newton.pdf}
    \end{figure}
\end{minipage}\tabularnewline
Fig.4 Reduced-space hierarchical Newton solver.\tabularnewline
\bottomrule
\end{longtable}

This algorithm is implemented below in Python.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{4}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} these are your coupled disciplines}
\PY{n}{U1} \PY{o}{=} \PY{k}{lambda} \PY{n}{uj}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{u}\PY{p}{)} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{v}\PY{p}{)} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{uj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
\PY{n}{U2} \PY{o}{=} \PY{k}{lambda} \PY{n}{uj}\PY{p}{:} \PY{l+m+mi}{1}\PY{o}{/}\PY{n}{u} \PY{o}{+} \PY{l+m+mi}{1}\PY{o}{/}\PY{n}{w} \PY{o}{+} \PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{uj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}

\PY{c+c1}{\PYZsh{} These are the Jacobians of your disciplines}
\PY{n}{dU1} \PY{o}{=} \PY{k}{lambda} \PY{n}{uj}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{uj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}\PY{p}{]}\PY{p}{)}
\PY{n}{dU2} \PY{o}{=} \PY{k}{lambda} \PY{n}{uj}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{uj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}

\PY{n}{u} \PY{o}{=} \PY{l+m+mi}{1}
\PY{n}{v} \PY{o}{=} \PY{l+m+mi}{1}
\PY{n}{w} \PY{o}{=} \PY{l+m+mi}{1}
\PY{n}{a0}\PY{o}{=}\PY{l+m+mi}{100}
\PY{n}{b0}\PY{o}{=}\PY{l+m+mi}{100}
\PY{n}{uk} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{a0}\PY{p}{,}\PY{n}{b0}\PY{p}{]}\PY{p}{)}
\PY{n}{k} \PY{o}{=} \PY{l+m+mi}{0}
\PY{n}{e} \PY{o}{=} \PY{l+m+mf}{1e\PYZhy{}6}
\PY{n}{disciplines} \PY{o}{=} \PY{p}{[}\PY{n}{U1}\PY{p}{,}\PY{n}{U2}\PY{p}{]}
\PY{n}{Jacobians} \PY{o}{=} \PY{p}{[}\PY{n}{dU1}\PY{p}{,}\PY{n}{dU2}\PY{p}{]}

\PY{k}{while} \PY{k+kc}{True}\PY{p}{:}
    \PY{n}{U} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros\PYZus{}like}\PY{p}{(}\PY{n}{uk}\PY{p}{)}
    \PY{n}{drdU} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{uk}\PY{p}{)}\PY{p}{,}\PY{n+nb}{len}\PY{p}{(}\PY{n}{uk}\PY{p}{)}\PY{p}{)}\PY{p}{)}
    \PY{k}{for} \PY{n}{i}\PY{p}{,}\PY{p}{(}\PY{n}{discipline}\PY{p}{,}\PY{n}{Jacobian}\PY{p}{)} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n+nb}{zip}\PY{p}{(}\PY{n}{disciplines}\PY{p}{,}\PY{n}{Jacobians}\PY{p}{)}\PY{p}{)}\PY{p}{:}
        \PY{n}{mask} \PY{o}{=} \PY{p}{[}\PY{k+kc}{True}\PY{p}{,}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{disciplines}\PY{p}{)}
        \PY{n}{mask}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{k+kc}{False} \PY{c+c1}{\PYZsh{} select all state variables but current one}
        \PY{n}{U}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{discipline}\PY{p}{(}\PY{n}{uk}\PY{p}{[}\PY{n}{mask}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} estimate coupling variables}
        \PY{n}{drdU}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{n}{mask}\PY{p}{]} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{n}{Jacobian}\PY{p}{(}\PY{n}{uk}\PY{p}{[}\PY{n}{mask}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} estimate gradient of coupling variables}

    \PY{n}{r} \PY{o}{=} \PY{n}{uk} \PY{o}{\PYZhy{}} \PY{n}{U} \PY{c+c1}{\PYZsh{} residuals}
    \PY{k}{if} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{r}\PY{p}{)} \PY{o}{\PYZlt{}}\PY{o}{=} \PY{n}{e} \PY{o+ow}{or} \PY{n}{k} \PY{o}{\PYZgt{}} \PY{l+m+mi}{100}\PY{p}{:}
        \PY{k}{break}
    
    \PY{c+c1}{\PYZsh{} Newton\PYZhy{}Raphson step}
    \PY{n}{du} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{drdU}\PY{p}{)} \PY{o}{@} \PY{o}{\PYZhy{}}\PY{n}{r}
    \PY{n}{uk} \PY{o}{=} \PY{n}{uk} \PY{o}{+} \PY{n}{du}
    \PY{n}{k}\PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
    \PY{n+nb}{print}\PY{p}{(}\PY{n}{uk}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
[3.02009699 2.00969799]
[0.96977098 2.55590709]
[1.07893819 2.91509142]
[1.07507004 2.93015913]
[1.07506292 2.93017725]
    \end{Verbatim}

    We found a solution for \(a\) and \(b\). You can plug those values into
your calculator and check that they satisfy the Equations in (4)
yourself!

However, we had to provide the Jacobian of the analysis functions
\(\dfrac{\partial\mathcal{U}}{\partial\hat{\mathbf{u}}}\) with respect
to the state variables
\(\hat{\mathbf{u}} = \begin{bmatrix} \hat{a} & \hat{b} \end{bmatrix}^\mathrm{T}\)
for the solver to converge. When \(\mathcal{U}_1\) and \(\mathcal{U}_2\)
are blackboxes (as in the aerostructural problem at the beginning of
this notebook), we seldom have access to residuals, let alone gradient
information! In other words, we sort of cheated.

    \hypertarget{multidisciplinary-design-optimization}{%
\section{Multidisciplinary design
optimization}\label{multidisciplinary-design-optimization}}

Since the MDA seems to converge when using the reduced Newton solver, we
will use it to solve the optimization problem (1) at the beginning of
this notebook. Solving the optimization problem using an MDA is known as
Multidisciplinary feasible (MDF) approach.

\hypertarget{multidisciplinary-feasible-mdf-optimization}{%
\subsection{Multidisciplinary feasible (MDF)
optimization}\label{multidisciplinary-feasible-mdf-optimization}}

\begin{equation*}
    \begin{aligned}
        & \underset{u,v,w}{\text{minimize}}
        & & f(u,v,w) = u+v+\hat{a}(u,v,w)+\hat{b}(u,v,w)\\
        & \text{subject to}
        & & g(u,v,w) = w + \hat{b}(u,v,w) -10 \leq 0\\
        & & & 0 \leq u,v,w \leq 10\\
    \end{aligned}
    \tag{5}
\end{equation*}

The above optimization problem is called a Multi-disciplinary feasible
(MDF) MDO problem since it relies on a monolithic MDA. Note that we have
switched out \(a\) and \(b\) by their MDA counterparts \(\hat{a}\) and
\(\hat{b}\) which need to be solved for during every optimization loop!

We can use a blackbox optimization algorithm to solve the problem, where
the blackbox in this case is the MDA we developed in the previous
section. We define the blackbox below.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{5}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} these are your coupled disciplines}
\PY{n}{U1} \PY{o}{=} \PY{k}{lambda} \PY{n}{x}\PY{p}{,}\PY{n}{uj}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{uj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}
\PY{n}{U2} \PY{o}{=} \PY{k}{lambda} \PY{n}{x}\PY{p}{,}\PY{n}{uj}\PY{p}{:} \PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{uj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}

\PY{c+c1}{\PYZsh{} These are the Jacobians of your disciplines}
\PY{n}{dU1} \PY{o}{=} \PY{k}{lambda} \PY{n}{x}\PY{p}{,}\PY{n}{uj}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{uj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}\PY{p}{]}\PY{p}{)}
\PY{n}{dU2} \PY{o}{=} \PY{k}{lambda} \PY{n}{x}\PY{p}{,}\PY{n}{uj}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{uj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}

\PY{k}{def} \PY{n+nf}{my\PYZus{}MDA}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{u0}\PY{p}{,}\PY{n}{disciplines}\PY{p}{,}\PY{n}{Jacobians}\PY{p}{,}\PY{n}{epsilon}\PY{o}{=}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{,}\PY{n}{k\PYZus{}max}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{)}\PY{p}{:}
    \PY{n}{uk} \PY{o}{=} \PY{n}{u0}
    \PY{n}{k} \PY{o}{=} \PY{l+m+mi}{0}
    \PY{n}{disciplines} \PY{o}{=} \PY{p}{[}\PY{n}{U1}\PY{p}{,}\PY{n}{U2}\PY{p}{]}
    \PY{n}{Jacobians} \PY{o}{=} \PY{p}{[}\PY{n}{dU1}\PY{p}{,}\PY{n}{dU2}\PY{p}{]}
    \PY{k}{while} \PY{k+kc}{True}\PY{p}{:}
        \PY{n}{U} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros\PYZus{}like}\PY{p}{(}\PY{n}{uk}\PY{p}{)}
        \PY{n}{drdU} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{uk}\PY{p}{)}\PY{p}{,}\PY{n+nb}{len}\PY{p}{(}\PY{n}{uk}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        \PY{k}{for} \PY{n}{i}\PY{p}{,}\PY{p}{(}\PY{n}{discipline}\PY{p}{,}\PY{n}{Jacobian}\PY{p}{)} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n+nb}{zip}\PY{p}{(}\PY{n}{disciplines}\PY{p}{,}\PY{n}{Jacobians}\PY{p}{)}\PY{p}{)}\PY{p}{:}
            \PY{n}{mask} \PY{o}{=} \PY{p}{[}\PY{k+kc}{True}\PY{p}{,}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{disciplines}\PY{p}{)}
            \PY{n}{mask}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{k+kc}{False} \PY{c+c1}{\PYZsh{} select all state variables but current one}
            \PY{n}{U}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{discipline}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{uk}\PY{p}{[}\PY{n}{mask}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} estimate coupling variables}
            \PY{n}{drdU}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{n}{mask}\PY{p}{]} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{n}{Jacobian}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{uk}\PY{p}{[}\PY{n}{mask}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} estimate gradient of coupling variables}

        \PY{n}{r} \PY{o}{=} \PY{n}{uk} \PY{o}{\PYZhy{}} \PY{n}{U} \PY{c+c1}{\PYZsh{} residuals}
        \PY{k}{if} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{r}\PY{p}{)} \PY{o}{\PYZlt{}}\PY{o}{=} \PY{n}{epsilon} \PY{o+ow}{or} \PY{n}{k} \PY{o}{\PYZgt{}} \PY{n}{k\PYZus{}max}\PY{p}{:}
            \PY{k}{break}
        
        \PY{c+c1}{\PYZsh{} Newton\PYZhy{}Raphson step}
        \PY{n}{du} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{drdU}\PY{p}{)} \PY{o}{@} \PY{o}{\PYZhy{}}\PY{n}{r}
        \PY{n}{uk} \PY{o}{=} \PY{n}{uk} \PY{o}{+} \PY{n}{du}
        \PY{n}{k}\PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}

    \PY{k}{return} \PY{n}{uk}

\PY{n}{u} \PY{o}{=} \PY{l+m+mf}{0.0}
\PY{n}{v} \PY{o}{=} \PY{l+m+mf}{0.0}
\PY{n}{w} \PY{o}{=} \PY{l+m+mf}{0.0}
\PY{n}{x} \PY{o}{=} \PY{p}{[}\PY{n}{u}\PY{p}{,}\PY{n}{v}\PY{p}{,}\PY{n}{w}\PY{p}{]}
\PY{n}{state0}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{l+m+mi}{100}\PY{p}{,}\PY{l+m+mi}{100}\PY{p}{]}\PY{p}{)}
\PY{n}{disciplines} \PY{o}{=} \PY{p}{[}\PY{n}{U1}\PY{p}{,}\PY{n}{U2}\PY{p}{]}
\PY{n}{Jacobians} \PY{o}{=} \PY{p}{[}\PY{n}{dU1}\PY{p}{,}\PY{n}{dU2}\PY{p}{]}

\PY{n}{u\PYZus{}hat} \PY{o}{=} \PY{n}{my\PYZus{}MDA}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{state0}\PY{p}{,}\PY{n}{disciplines}\PY{p}{,}\PY{n}{Jacobians}\PY{p}{)}
\PY{n+nb}{print}\PY{p}{(}\PY{n}{u\PYZus{}hat}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
[-1.31223634e+01  1.99999992e+06]
    \end{Verbatim}

    A blackbox that returns the objective and constraint value can now be
defined as follows:

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{6}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{my\PYZus{}bb}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{args}\PY{p}{)}\PY{p}{:}

    \PY{n}{state0} \PY{o}{=} \PY{n}{args}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
    \PY{n}{disciplines} \PY{o}{=} \PY{n}{args}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
    \PY{n}{Jacobians} \PY{o}{=} \PY{n}{args}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}

    \PY{n}{u\PYZus{}hat} \PY{o}{=} \PY{n}{my\PYZus{}MDA}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{state0}\PY{p}{,}\PY{n}{disciplines}\PY{p}{,}\PY{n}{Jacobians}\PY{p}{)}
    \PY{n}{f} \PY{o}{=} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+} \PY{n}{u\PYZus{}hat}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{u\PYZus{}hat}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
    \PY{n}{g} \PY{o}{=} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]} \PY{o}{+} \PY{n}{u\PYZus{}hat}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{l+m+mf}{10.0}

    \PY{k}{return} \PY{p}{[}\PY{n}{f}\PY{p}{,}\PY{p}{[}\PY{n}{g}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{n}{u\PYZus{}hat}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{n}{u\PYZus{}hat}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{]}
\end{Verbatim}
\end{tcolorbox}

    The blackbox above is what we can feed to
\href{https://ahmed-bayoumy.github.io/OMADS/}{\texttt{OMADS}}.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{7}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k+kn}{import} \PY{n+nn}{OMADS}

\PY{c+c1}{\PYZsh{} Optimization setup}
\PY{n}{u0} \PY{o}{=} \PY{l+m+mf}{1.0}\PY{p}{;} \PY{n}{v0} \PY{o}{=} \PY{l+m+mf}{1.0}\PY{p}{;} \PY{n}{w0} \PY{o}{=} \PY{l+m+mf}{1.0}
\PY{n}{x0} \PY{o}{=} \PY{p}{[}\PY{n}{u0}\PY{p}{,}\PY{n}{v0}\PY{p}{,}\PY{n}{w0}\PY{p}{]}

\PY{n}{f}\PY{p}{,}\PY{n}{g} \PY{o}{=} \PY{n}{my\PYZus{}bb}\PY{p}{(}\PY{n}{x0}\PY{p}{,}\PY{n}{args}\PY{o}{=}\PY{p}{[}\PY{n}{state0}\PY{p}{,}\PY{n}{disciplines}\PY{p}{,}\PY{n}{Jacobians}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} its a good idea to test the blackbox function first at the initial guess}

\PY{n}{lb} \PY{o}{=} \PY{p}{[}\PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{]}
\PY{n}{ub} \PY{o}{=} \PY{p}{[}\PY{l+m+mf}{10.}\PY{p}{,} \PY{l+m+mf}{10.}\PY{p}{,} \PY{l+m+mf}{10.}\PY{p}{]}

\PY{n+nb}{eval} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{blackbox}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n}{my\PYZus{}bb}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{constants}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{p}{[}\PY{n}{state0}\PY{p}{,}\PY{n}{disciplines}\PY{p}{,}\PY{n}{Jacobians}\PY{p}{]}\PY{p}{\PYZcb{}} \PY{c+c1}{\PYZsh{} you can pass blackbox specific options using the ``constants`` key}
\PY{n}{param} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{baseline}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n}{x0}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{lb}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n}{lb}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{ub}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n}{ub}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{var\PYZus{}names}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{u}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{v}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{w}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{scaling}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+m+mf}{10.0}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{post\PYZus{}dir}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{./post}\PY{l+s+s2}{\PYZdq{}}\PY{p}{\PYZcb{}} \PY{c+c1}{\PYZsh{} these are OMADS specific options. You can modify them as necessary}
\PY{n}{options} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{seed}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{budget}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+m+mi}{100000}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{tol}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+m+mf}{1e\PYZhy{}12}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{display}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{k+kc}{False}\PY{p}{\PYZcb{}}

\PY{n}{data} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{evaluator}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n+nb}{eval}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{param}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n}{param}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{options}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}\PY{n}{options}\PY{p}{\PYZcb{}}

\PY{n}{out} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
\PY{c+c1}{\PYZsh{} out is a dictionary that will hold output data of the final solution. The out dictionary has three keys: \PYZdq{}xmin\PYZdq{}, \PYZdq{}fmin\PYZdq{} and \PYZdq{}hmin\PYZdq{}}

\PY{n}{out} \PY{o}{=} \PY{n}{OMADS}\PY{o}{.}\PY{n}{main}\PY{p}{(}\PY{n}{data}\PY{p}{)}
\PY{n}{fopt}\PY{p}{,}\PY{n}{gopt} \PY{o}{=} \PY{n}{my\PYZus{}bb}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{,}\PY{n}{args}\PY{o}{=}\PY{p}{[}\PY{n}{state0}\PY{p}{,}\PY{n}{disciplines}\PY{p}{,}\PY{n}{Jacobians}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} evaluate blackbox at optimizer}
\PY{n}{uopt} \PY{o}{=} \PY{n}{my\PYZus{}MDA}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{,}\PY{n}{state0}\PY{p}{,}\PY{n}{disciplines}\PY{p}{,}\PY{n}{Jacobians}\PY{p}{)} \PY{c+c1}{\PYZsh{} evaluate MDA at optimizer}

\PY{k+kn}{import} \PY{n+nn}{json}
\PY{k}{for} \PY{n}{key}\PY{p}{,}\PY{n}{value} \PY{o+ow}{in} \PY{n}{out}\PY{o}{.}\PY{n}{items}\PY{p}{(}\PY{p}{)}\PY{p}{:}
    \PY{n+nb}{print}\PY{p}{(}\PY{n}{key}\PY{p}{,}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{ : }\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{value}\PY{p}{)}
\PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{===========================}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{f\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}f(}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*) = }\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{fmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{f\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} minimum}
\PY{n}{x\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*\PYZdl{} = \PYZdl{}[}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{]\PYZca{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+si}{\PYZob{}T\PYZcb{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{x\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} optimizer}
\PY{n}{g\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}g(}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*)\PYZdl{} = \PYZdl{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{gopt}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{g\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} constraints}
\PY{n}{u\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{hat}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}u\PYZcb{}}\PY{l+s+s2}{\PYZcb{}(}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*)\PYZdl{} = \PYZdl{}[}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{]\PYZca{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+si}{\PYZob{}T\PYZcb{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{uopt}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{uopt}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{u\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} constraints}
\PY{c+c1}{\PYZsh{} print(f\PYZus{}tex)}
\PY{c+c1}{\PYZsh{} print(x\PYZus{}tex)}
\PY{c+c1}{\PYZsh{} print(g\PYZus{}tex)}
\PY{c+c1}{\PYZsh{} print(u\PYZus{}tex)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
xmin  :  [1.1874999999927240424, 0.74511669576168060303, 7.6562655009329319]
fmin  :  5.005735228721652552
hmin  :  9.996378214847634363e-19
nbb\_evals  :  469
niterations  :  78
nb\_success  :  27
psize  :  9.094947017729282379e-13
psuccess  :  7.2759576141834259033e-12
pmax  :  2.0
===========================
    \end{Verbatim}

    $f(\mathbf{x}^*) = 5.0057$

    
    $\mathbf{x}^*$ = $[1.1875~~0.7451~~7.6563]^\mathrm{T}$

    
    $g(\mathbf{x}^*)$ = $0.0000$

    
    $\hat{\mathbf{u}}(\mathbf{x}^*)$ = $[0.7294~~2.3437]^\mathrm{T}$

    
    We can see that we obtained a solution to the optimization problem in
Equation (5). This entire process above is known as MDF. You should
resort to MDF if you manage to find an MDA that converges robustly.
i.e., for every possible value of the optimization variables
\(\mathbf{x}\in\mathcal{F}\), where \(\mathcal{F}\) is your feasible
design space that satisfies all your constraints.

The XDSM diagram and its corresponding block diagram for the MDF
optimization we just performed is given below:

\begin{longtable}[]{@{}c@{}}
    \toprule
    \endhead
    \begin{minipage}[t]{0.97\columnwidth}\centering
        \begin{figure}
            \centering
            \includegraphics[width=0.9\textwidth]{mdf.pdf}
        \end{figure}
        \begin{figure}
            \centering
            \includegraphics[width=0.9\textwidth]{images/MDF_diagram_numerical.png}
        \end{figure}
    \end{minipage}\tabularnewline
    Fig.5 MDF using a reduced-space hierarchical Newton MDA.\tabularnewline
    \bottomrule
\end{longtable}

or more compactly and generally, as follows:

\begin{longtable}[]{@{}c@{}}
    \toprule
    \endhead
    \begin{minipage}[t]{0.97\columnwidth}\centering
        \begin{figure}
            \centering
            \includegraphics[width=0.9\textwidth]{mdf_newton_compact.pdf}
        \end{figure}
        \begin{figure}
            \centering
            \includegraphics[width=0.9\textwidth]{images/MDF_diagram_newton.png}
        \end{figure}
    \end{minipage}\tabularnewline
    Fig.6 MDF using a reduced-space hierarchical Newton MDA (generic problem).\tabularnewline
    \bottomrule
\end{longtable}

However, as mention earlier we cheated by using the coupled gradients
\(\dfrac{\partial\mathcal{U}}{\partial\hat{\mathbf{u}}}\). We will now
try to solve the above problem without having to resort to an MDA
altogether.

    \hypertarget{individual-disciplinary-feasible-idf-optimization}{%
\subsection{Individual disciplinary feasible (IDF)
optimization}\label{individual-disciplinary-feasible-idf-optimization}}

We can do away with MDA by letting the optimization algorithm handle to
the convergence of the disciplines (i.e., coordinate their solutions).
This is done by creating new variables \(\mathbf{u}^t\) known as
\emph{target variables}. They are essentially a copy of the actual state
variables. We then introduce consistency constraints
\(\mathbf{h}_c = \mathbf{u}^t - \mathbf{u} = \mathbf{0}\) to the
original optimization problem. The original optimization problem in
Equation (3) becomes:

\begin{equation*}
    \begin{aligned}
        & \underset{u,v,w,\hat{a}^t,\hat{b}^t}{\text{minimize}}
        & & f(\mathbf{x};\hat{a},\hat{b}) = u+v+\hat{a}+\hat{b}\\
        & \text{subject to}
        & & g(\mathbf{x};\hat{b}) = w + \hat{b} -10 \leq 0\\
        & & & h_1^c(\hat{a}^t;\hat{a}) = \hat{a}^t - \hat{a} = 0\\
        & & & h_2^c(\hat{b}^t;\hat{b}) = \hat{b}^t - \hat{b} = 0\\
        & & & 0 \leq u,v,w \leq 10\\
        & \text{while solving}
        & & r_1(\hat{a};\mathbf{x},\hat{b}^t) = \hat{a} - \left(\log(u) + \log(v) + \log(\hat{b}^t)\right) = 0\\
        & & & r_2(\hat{b};\mathbf{x},\hat{a}^t) = \hat{b} - \left(\dfrac{1}{u} + \dfrac{1}{w} + \dfrac{1}{\hat{a}^t}\right) = 0\\
        & \text{for a given $u$, $v$, $w$, $\hat{a}^t$ and $\hat{b}^t$}
    \end{aligned}
    \tag{6}
\end{equation*}

Notice that the optimization algorithm must now control 5 variables
simultaneously and has two additional equality constraints to worry
about. If those copies of the state variables were displacement and
vortex fields from the aerostructural problem, the optimization
algorithm must control tens of thousands of variables and might go
bananas.

For now since our problem is small, let us attempt to solve it again
using \texttt{OMADS}. We first define the blackbox associated with IDF.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{8}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{my\PYZus{}bb}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{args}\PY{p}{)}\PY{p}{:}

    \PY{n}{at} \PY{o}{=} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{;} \PY{n}{bt} \PY{o}{=} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{4}\PY{p}{]} \PY{c+c1}{\PYZsh{} target variables}
    \PY{n}{ut} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{at}\PY{p}{,}\PY{n}{bt}\PY{p}{]}\PY{p}{)}
    \PY{n}{disciplines} \PY{o}{=} \PY{n}{args}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}

    \PY{c+c1}{\PYZsh{} solve for coupling variables}
    \PY{n}{u\PYZus{}hat} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{disciplines}\PY{p}{)}\PY{p}{)}
    \PY{k}{for} \PY{n}{i}\PY{p}{,}\PY{n}{discipline} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{disciplines}\PY{p}{)}\PY{p}{:}
        \PY{n}{mask} \PY{o}{=} \PY{p}{[}\PY{k+kc}{True}\PY{p}{,}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{disciplines}\PY{p}{)}
        \PY{n}{mask}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{k+kc}{False} \PY{c+c1}{\PYZsh{} select all state variables but current one}
        \PY{n}{u\PYZus{}hat}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{discipline}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{ut}\PY{p}{[}\PY{n}{mask}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} estimate coupling variables}

    \PY{n}{f} \PY{o}{=} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+} \PY{n}{u\PYZus{}hat}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{u\PYZus{}hat}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
    \PY{n}{g} \PY{o}{=} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]} \PY{o}{+} \PY{n}{u\PYZus{}hat}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{l+m+mf}{10.0}
    \PY{n}{gc} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{ut} \PY{o}{\PYZhy{}} \PY{n}{u\PYZus{}hat}\PY{p}{)} \PY{o}{\PYZhy{}} \PY{l+m+mf}{1e\PYZhy{}6}

    \PY{k}{return} \PY{p}{[}\PY{n}{f}\PY{p}{,}\PY{p}{[}\PY{n}{g}\PY{p}{,}\PY{n}{gc}\PY{p}{]}\PY{p}{]}
\end{Verbatim}
\end{tcolorbox}

    Note that I had to slightly reformulate the consistency constraints
\(h_1^c\) and \(h_2^c\) as an inequality constraint
\({g}^c = \left|\left|\mathbf{u}^t - \mathbf{u}\right|\right| - \varepsilon \leq 0\)
since \texttt{OMADS} does not yet support equality constraints.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{9}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} Optimization setup}
\PY{n}{u0} \PY{o}{=} \PY{l+m+mf}{1.0}\PY{p}{;} \PY{n}{v0} \PY{o}{=} \PY{l+m+mf}{1.0}\PY{p}{;} \PY{n}{w0} \PY{o}{=} \PY{l+m+mf}{1.0}\PY{p}{;} \PY{n}{a0} \PY{o}{=} \PY{l+m+mf}{1.0}\PY{p}{;} \PY{n}{b0} \PY{o}{=} \PY{l+m+mf}{1.0}
\PY{n}{x0} \PY{o}{=} \PY{p}{[}\PY{n}{u0}\PY{p}{,}\PY{n}{v0}\PY{p}{,}\PY{n}{w0}\PY{p}{,}\PY{n}{a0}\PY{p}{,}\PY{n}{b0}\PY{p}{]}

\PY{n}{f}\PY{p}{,}\PY{n}{g} \PY{o}{=} \PY{n}{my\PYZus{}bb}\PY{p}{(}\PY{n}{x0}\PY{p}{,}\PY{n}{args}\PY{o}{=}\PY{p}{[}\PY{n}{disciplines}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} its a good idea to test the blackbox function first at the initial guess}

\PY{n}{lb} \PY{o}{=} \PY{p}{[}\PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{]}
\PY{n}{ub} \PY{o}{=} \PY{p}{[}\PY{l+m+mf}{10.}\PY{p}{,} \PY{l+m+mf}{10.}\PY{p}{,} \PY{l+m+mf}{10.}\PY{p}{,} \PY{l+m+mf}{10.}\PY{p}{,} \PY{l+m+mf}{10.}\PY{p}{]}

\PY{n+nb}{eval} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{blackbox}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n}{my\PYZus{}bb}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{constants}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{p}{[}\PY{n}{disciplines}\PY{p}{]}\PY{p}{\PYZcb{}} \PY{c+c1}{\PYZsh{} you can pass blackbox specific options using the ``constants`` key}
\PY{n}{param} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{baseline}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n}{x0}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{lb}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n}{lb}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{ub}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n}{ub}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{var\PYZus{}names}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{u}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{v}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{w}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{a\PYZca{}t}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{b\PYZca{}t}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{scaling}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+m+mf}{10.0}\PY{p}{,}
        \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{post\PYZus{}dir}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{./post}\PY{l+s+s2}{\PYZdq{}}\PY{p}{\PYZcb{}} \PY{c+c1}{\PYZsh{} these are OMADS specific options. You can modify them as necessary}
\PY{n}{options} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{seed}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{budget}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+m+mi}{100000}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{tol}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+m+mf}{1e\PYZhy{}12}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{display}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{k+kc}{False}\PY{p}{\PYZcb{}}

\PY{n}{data} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{evaluator}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n+nb}{eval}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{param}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{n}{param}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{options}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}\PY{n}{options}\PY{p}{\PYZcb{}}

\PY{n}{out} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
\PY{c+c1}{\PYZsh{} out is a dictionary that will hold output data of the final solution. The out dictionary has three keys: \PYZdq{}xmin\PYZdq{}, \PYZdq{}fmin\PYZdq{} and \PYZdq{}hmin\PYZdq{}}

\PY{n}{out} \PY{o}{=} \PY{n}{OMADS}\PY{o}{.}\PY{n}{main}\PY{p}{(}\PY{n}{data}\PY{p}{)}
\PY{n}{fopt}\PY{p}{,}\PY{n}{gopt} \PY{o}{=} \PY{n}{my\PYZus{}bb}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{,}\PY{n}{args}\PY{o}{=}\PY{p}{[}\PY{n}{disciplines}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} evaluate blackbox at optimizer}
\PY{n}{uopt} \PY{o}{=} \PY{n}{my\PYZus{}MDA}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{,}\PY{n}{state0}\PY{p}{,}\PY{n}{disciplines}\PY{p}{,}\PY{n}{Jacobians}\PY{p}{)} \PY{c+c1}{\PYZsh{} evaluate MDA at optimizer to check the true state variables}

\PY{k+kn}{import} \PY{n+nn}{json}
\PY{k}{for} \PY{n}{key}\PY{p}{,}\PY{n}{value} \PY{o+ow}{in} \PY{n}{out}\PY{o}{.}\PY{n}{items}\PY{p}{(}\PY{p}{)}\PY{p}{:}
    \PY{n+nb}{print}\PY{p}{(}\PY{n}{key}\PY{p}{,}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{ : }\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{value}\PY{p}{)}
\PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{===========================}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{f\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}f(}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*) = }\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{fmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{f\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} minimum}
\PY{n}{x\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*\PYZdl{} = \PYZdl{}[}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{]\PYZca{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+si}{\PYZob{}T\PYZcb{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{x\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} optimizer}
\PY{n}{g\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}g(}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*)\PYZdl{} = \PYZdl{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{gopt}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{g\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} constraints}
\PY{n}{gc\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}g\PYZus{}c(}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*)\PYZdl{} = \PYZdl{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{gopt}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{gc\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} inconsistency}
\PY{n}{ut\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{hat}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}u\PYZcb{}}\PY{l+s+s2}{\PYZcb{}\PYZca{}t\PYZdl{} = \PYZdl{}[}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{]\PYZca{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+si}{\PYZob{}T\PYZcb{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{,}\PY{n}{out}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{xmin}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{4}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{ut\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} target states}
\PY{n}{u\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{hat}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}u\PYZcb{}}\PY{l+s+s2}{\PYZcb{}\PYZdl{} = \PYZdl{}[}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{]\PYZca{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+si}{\PYZob{}T\PYZcb{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{uopt}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{uopt}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{u\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} states}
\PY{c+c1}{\PYZsh{} print(f\PYZus{}tex)}
\PY{c+c1}{\PYZsh{} print(x\PYZus{}tex)}
\PY{c+c1}{\PYZsh{} print(g\PYZus{}tex)}
\PY{c+c1}{\PYZsh{} print(u\PYZus{}tex)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
xmin  :  [1.0, 1.20812225341796875, 3.999998461147697526, 1.0,
2.249998331069946289]
fmin  :  5.458119331294737586
hmin  :  9.9995692311506984225e-19
nbb\_evals  :  1261
niterations  :  126
nb\_success  :  46
psize  :  9.094947017729282379e-13
psuccess  :  1.8189894035458564758e-12
pmax  :  4.0
===========================
    \end{Verbatim}

    $f(\mathbf{x}^*) = 5.4581$

    
    $\mathbf{x}^*$ = $[1.0000~~1.2081~~4.0000]^\mathrm{T}$

    
    $g(\mathbf{x}^*)$ = $-3.7500$

    
    $g_c(\mathbf{x}^*)$ = $0.0000$

    
    $\hat{\mathbf{u}}^t$ = $[1.0000~~2.2500]^\mathrm{T}$

    
    $\hat{\mathbf{u}}$ = $[1.0000~~2.2500]^\mathrm{T}$

    
    We converged to a solution thats worse than the one obtained through MDF
because of the larger number of variables and constraints that the
optimizer has to handle. Imagine what would happen if we tried solving
the aerostructural program using IDF.

However, there is a silver lining. The solution is a feasible one since
the target variables \(\hat{\mathbf{u}}^t\) match the true state
variables \(\hat{\mathbf{u}}\) obtained from the MDA.

The XDSM for the IDF optimization approach and its corresponding block
diagram is shown below.

\begin{longtable}[]{@{}c@{}}
    \toprule
    \endhead
    \begin{minipage}[t]{0.97\columnwidth}\centering
        \begin{figure}
            \centering
            \includegraphics[width=0.9\textwidth]{idf.pdf}
        \end{figure}
        \begin{figure}
            \centering
            \includegraphics[width=0.9\textwidth]{images/IDF_diagram_numerical.png}
        \end{figure}
    \end{minipage}\tabularnewline
    Fig.7 IDF architecture of the numerical example.\tabularnewline
    \bottomrule
\end{longtable}

The general IDF architecture is given by the following XDSM and block
diagrams:

\begin{longtable}[]{@{}c@{}}
    \toprule
    \endhead
    \begin{minipage}[t]{0.97\columnwidth}\centering
        \begin{figure}
            \centering
            \includegraphics[width=0.9\textwidth]{idf_compact.pdf}
        \end{figure}
        \begin{figure}
            \centering
            \includegraphics[width=0.9\textwidth]{images/IDF_diagram.png}
        \end{figure}
    \end{minipage}\tabularnewline
    Fig.8 IDF architecture for a generic problem.\tabularnewline
    \bottomrule
\end{longtable}

    \hypertarget{distributed-mdo}{%
\subsection{Distributed MDO}\label{distributed-mdo}}

The state-of-the-art in multidisciplinary design optimization (MDO) is
known as distributed MDO (DMDO). There are a plethora if DMDO
architectures out there. We will focus on a simple one first introduced
by
\href{https://asmedigitalcollection.asme.org/mechanicaldesign/article-abstract/125/3/481/476066/Analytical-Target-Cascading-in-Automotive-Vehicle?redirectedFrom=fulltext}{Kim
et al.~(2003)} and later formalized as an MDO architecture by
\href{https://link.springer.com/article/10.1007/s00158-005-0579-0}{Tosserams
et al.~(2006)}.

The MDO architecture referenced above is known as \emph{analytical
target cascading (ATC)}. In this architecture we use a divide and
conquer strategy by splitting up our optimization problem into a system
level problem and several discipline subproblems. Notice that in IDF,
and MDF we still solved only one optimization problem.

We first must introduce the notion of \emph{shared variables}
\(\mathbf{x}_0\) and \emph{local variables} \(\mathbf{x}_i\) which are
local to discipline \(i\). This means that our vector of design
variables becomes
\(\mathbf{x} = \begin{bmatrix} \mathbf{x}_0^\mathrm{T} & \mathbf{x}_1^\mathrm{T} & \cdots & \mathbf{x}_m^\mathrm{T} \end{bmatrix}\).

We can do the same thing for constraints. We \emph{nonlocal constraints}
\(\mathbf{g}_0\) and \emph{local constraints} \(\mathbf{g}_i\) for
discipline \(i\). This means that our vector of design constraints
becomes
\(\mathbf{g} = \begin{bmatrix} \mathbf{g}_0^\mathrm{T} & \mathbf{g}_1^\mathrm{T} & \cdots & \mathbf{g}_m^\mathrm{T} \end{bmatrix}\).

\textbf{System-level optimization problem}

In ATC, the system level problem modifies the original problem as
follows: 1) local constraints are removed, 2) target coupling variables
\(\mathbf{u}^t\) are added as design variables (just like IDF), and 3) a
penalty term (similar to the consistency constraints \(g_c\) we saw
earlier in IDF) to the system-level objective function \(f_0\) for
violating the consistency constraints.

\begin{equation*}
    \begin{aligned}
        & \underset{\mathbf{x}_0,\hat{\mathbf{u}}^t}{\text{minimize}}
        & & f_0(\mathbf{x}_0;\mathbf{x}_1,\cdots,\mathbf{x}_m,\hat{\mathbf{u}}^t) + \sum_{i=1}^m \Phi_i(\mathbf{x}_{0,i}^t - \mathbf{x}_{0}, \hat{\mathbf{u}}_{i}^t - \hat{\mathbf{u}}_{i}(\mathbf{x}_0,\mathbf{x}_i,\hat{\mathbf{u}}^t))\\
        & \text{subject to}
        & & \mathbf{g}_{0}(\mathbf{x}_0;\mathbf{x}_1,\cdots,\mathbf{x}_m,\hat{\mathbf{u}}^t) \leq \mathbf{0}
    \end{aligned}
    \tag{7}
\end{equation*}

going back to our numerical example, we can see that \(u\) is a shared
variable, while \(v\) and \(w\) are discipline variables. The system
level problem gets a copy of the state variable estimates from
disciplines 2 and 1 as \(\hat{a}^t\) and \(\hat{b}^t\), respectively,
while it gets the actual estimates \(\hat{a}\) and \(\hat{b}\) from
disciplines 1 and 2, respectively.

\begin{align*}
\mathbf{x}_0 & = \left[u\right]^\mathrm{T}\\
\mathbf{x}_1 & = \left[v\right]^\mathrm{T}\\
\mathbf{x}_2 & = \left[w\right]^\mathrm{T}\\
\hat{\mathbf{u}}_1 & = \left[\hat{a}\right]^\mathrm{T}\\
\hat{\mathbf{u}}_2 & = \left[\hat{b}\right]^\mathrm{T}\\
\hat{\mathbf{u}}_1^t & = \left[\hat{a}^t\right]^\mathrm{T}\\
\hat{\mathbf{u}}_2^t & = \left[\hat{b}^t\right]^\mathrm{T}\\
\end{align*}

There are no shared constraints \(\mathbf{g}_0\). \(f_0\) is our
objective function.
\(f_0(u;v,\hat{a}^t,\hat{b}^t) = u+v+\hat{a}^t+\hat{b}^t\). The system
level problem for our example in this notebook becomes:

\begin{equation*}
    \begin{aligned}
        & \underset{u,\hat{a}^t,\hat{b}^t}{\text{minimize}}
        & & u+v+\hat{a}^t+\hat{b}^t + \Phi_1(u_1^t - u, \hat{a}^t - \hat{a}(u,v,\hat{b}^t)) + \Phi_2(u_2^t - u, \hat{b}^t - \hat{b}(u,w,\hat{a}^t))
    \end{aligned}
    \tag{8}
\end{equation*}

Note that everything with a subscript of \(0\) belongs to the
system-level problem, while \(i\neq 0\) belongs to the individual
sub-system problems which we will talk about now.

\textbf{Sub-system optimization problem(s)}

In ATC, the sub-system level problems have their own local objectives
\(f_i\) and constraints \(g_i\), local variables \(\mathbf{x}_i\), and
target variables \(\hat{\mathbf{u}}_i^t\). They also have their
individual disciplinary analyses
\(r_i = \hat{\mathbf{u}}_i - \mathcal{U}_i = \mathbf{0}\) which need to
be satisfied. The \(i\)-th sub-system optimization problem is formulated
as

\begin{equation*}
    \begin{aligned}
        & \underset{\mathbf{x}_{0,i}^t,\mathbf{x}_i}{\text{minimize}}
        & & f_i(\mathbf{x}_{0,i}^t,\mathbf{x}_i;\hat{\mathbf{u}}_i) + \Phi_i(\hat{\mathbf{u}}_{i}^t - \hat{\mathbf{u}}_{i},\mathbf{x}_{0,i}^t - \mathbf{x}_{0})\\
        & \text{subject to}
        & & \mathbf{g}_i(\mathbf{x}_{0,i}^t,\mathbf{x}_i;\hat{\mathbf{u}}_i) \leq \mathbf{0}\\
        & \text{while solving}
        & & r_i(\hat{\mathbf{u}}_i;\mathbf{x}_{0,i}^t,\mathbf{x}_i,\hat{\mathbf{u}}_{j\neq i}^t) = \mathbf{0}\\
        & \text{for}
        & & \hat{\mathbf{u}}_i\\
    \end{aligned}
    \tag{9}
\end{equation*}

Going back to our numerical example, for discipline 1, we have no local
objectives \(f_1\) or constraints \(\mathbf{g}_1\). It will get a copy
of the shared variable \(u\) as \(u_1^t\). It has its own local design
variables \(v\), and its own state variable estimate \(\hat{a}\)
obtained by solving \(\hat{a} - \mathcal{U}_1(u_1^t,v,\hat{b}^t)=0\). It
gets a copy of the state variables estimate from the system level
problem (0) as \(\hat{a}^t\) and \(\hat{b}^t\). So now we have

\begin{align*}
\mathbf{x}_{0,1}^t & = \left[u_1^t\right]^\mathrm{T}\\
\mathbf{x}_1 & = \left[v\right]^\mathrm{T}\\
\hat{\mathbf{u}}_1 & = \left[\hat{a}\right]^\mathrm{T}\\
\hat{\mathbf{u}}_1^t & = \left[\hat{a}^t\right]^\mathrm{T}\\
\hat{\mathbf{u}}_2^t & = \left[\hat{b}^t\right]^\mathrm{T}\\
\end{align*}

and sub-system 1's optimization problem becomes

\begin{equation*}
    \begin{aligned}
        & \underset{u_1^t,v}{\text{minimize}}
        & & \Phi_1(\hat{a}^t - \hat{a},u_1^t - u)\\
        & \text{while solving}
        & & r_1(\hat{a};u_1^t,v,\hat{b}^t) = \hat{a} - \mathcal{U}_1(u_1^t,v,\hat{b}^t) = 0\\
        & \text{for}
        & & \hat{a}\\
    \end{aligned}
    \tag{10}
\end{equation*}

For discipline 2, we have no local objectives \(f_2\). We have a local
constraint
\(\mathbf{g}_2 = \left[g({u}_2^t,w,\hat{b})\right]^\mathrm{T}\).
Discipline 2 will get a copy of the shared variable \(u\) as \(u_2^t\).
It has its own local design variables \(w\), and its own state variable
estimate \(\hat{b}\) obtained by solving
\(\hat{b} - \mathcal{U}_2(u_2^t,w,\hat{a}^t)=0\). It gets a copy of the
state variables estimate from the system level problem (0) as
\(\hat{a}^t\) and \(\hat{b}^t\). So now we have

\begin{align*}
\mathbf{g}_2 & = \left[g(\hat{u}_2^t,w,\hat{b})\right]^\mathrm{T}\\
\mathbf{x}_{0,2}^t & = \left[u_2^t\right]^\mathrm{T}\\
\mathbf{x}_2 & = \left[w\right]^\mathrm{T}\\
\hat{\mathbf{u}}_2 & = \left[\hat{b}\right]^\mathrm{T}\\
\hat{\mathbf{u}}_1^t & = \left[\hat{a}^t\right]^\mathrm{T}\\
\hat{\mathbf{u}}_2^t & = \left[\hat{b}^t\right]^\mathrm{T}\\
\end{align*}

and sub-system 2's optimization problem becomes

\begin{equation*}
    \begin{aligned}
        & \underset{u_2^t,w}{\text{minimize}}
        & & \Phi_2(\hat{b}^t - \hat{b},u_2^t - u)\\
        & \text{subject to}
        & & g({u}_2^t,w,\hat{b}) = w + \hat{b} - 10 \leq 0\\
        & \text{while solving}
        & & r_2(\hat{b};u_2^t,w,\hat{a}^t) = \hat{b} - \mathcal{U}_2(u_2^t,w,\hat{a}^t) = 0\\
        & \text{for}
        & & \hat{b}\\
    \end{aligned}
    \tag{11}
\end{equation*}

The problem formulation can be represented using the following block
diagram:

\begin{longtable}[]{@{}c@{}}
\toprule
\endhead
\begin{minipage}[t]{0.97\columnwidth}\centering
    \begin{figure}
        \centering
        \includegraphics[width=0.9\textwidth]{images/ATC_diagram_numerical.png}
    \end{figure}
\end{minipage}\tabularnewline
Fig.9 Schematic of the numerical example's ATC problem formulation.\tabularnewline
\bottomrule
\end{longtable}

We can now begin implementing ATC. We have to define a total of 3
blackboxes. One for the system level problem, and two for each
discipline. The ATC algorithm also maintains and updates a vector of
weights \(\mathbf{w}_i\) and \(\mathbf{v}_i\) which are associated with
each penalty function \(\Phi_i\). These weights are continuously updated
during ATC iterations. The ATC algorithm is described by these steps:

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\setcounter{enumi}{-1}
\item
  Initiate main ATC iteration\\
  \textbf{repeat}\\
  \textbf{for} Each discipline \textbf{do}
\item
  Initiate discipline optimizer\\
  \textbf{repeat}

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii})}
  \setcounter{enumii}{1}
  \tightlist
  \item
    Evaluate disciplinary analysis
  \item
    Compute discipline objective and constraint functions and penalty
    function values
  \item
    Update discipline design variables
  \end{enumerate}

  \textbf{until} 4 \(\rightarrow\) 2: Discipline optimization has
  converged
\end{enumerate}

\textbf{end for}

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\setcounter{enumi}{4}
\item
  Initiate system optimizer\\
  \textbf{repeat}

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii})}
  \setcounter{enumii}{5}
  \tightlist
  \item
    Compute system objective, constraints, and all penalty functions
  \item
    Update system design variables and coupling targets.
  \end{enumerate}

  \textbf{until} 7 \(\rightarrow\) 6: System optimization has converged
\item
  Update penalty weights \textbf{until} 8 \(\rightarrow\) 1: maximum
  inconsistency
  \(\left|\left|\mathbf{g}^c\right|\right|_\infty \leq \varepsilon\)
\end{enumerate}

The implementation of this quite tedious and my own implementation of
ATC can be found in the file \url{atc.py}.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{10}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k+kn}{from} \PY{n+nn}{atc} \PY{k+kn}{import} \PY{n}{ATC}

\PY{c+c1}{\PYZsh{} these are your coupled disciplines}
\PY{n}{U1} \PY{o}{=} \PY{k}{lambda} \PY{n}{x0}\PY{p}{,}\PY{n}{xi}\PY{p}{,}\PY{n}{u}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{x0}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{xi}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}\PY{p}{]}\PY{p}{)}
\PY{n}{U2} \PY{o}{=} \PY{k}{lambda} \PY{n}{x0}\PY{p}{,}\PY{n}{xi}\PY{p}{,}\PY{n}{u}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{x0}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{xi}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}\PY{p}{]}\PY{p}{)}
\PY{n}{f} \PY{o}{=} \PY{k}{lambda} \PY{n}{x0}\PY{p}{,}\PY{n}{x}\PY{p}{,}\PY{n}{u}\PY{p}{:} \PY{n}{x0}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{u}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{u}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
\PY{n}{g} \PY{o}{=} \PY{k}{lambda} \PY{n}{x0}\PY{p}{,}\PY{n}{x}\PY{p}{,}\PY{n}{u}\PY{p}{:} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{u}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{l+m+mi}{10} \PY{c+c1}{\PYZsh{} is not using the shared variable (but could in practice)}
\PY{n}{g21} \PY{o}{=} \PY{k}{lambda} \PY{n}{x0}\PY{p}{,}\PY{n}{xi}\PY{p}{,}\PY{n}{ui}\PY{p}{:} \PY{n}{xi}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{ui}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{l+m+mi}{10} \PY{c+c1}{\PYZsh{} is not using the shared variable (but could in practice)}

\PY{c+c1}{\PYZsh{} system optimization problem}
\PY{n}{f\PYZus{}global} \PY{o}{=} \PY{n}{f}
\PY{n}{g\PYZus{}global} \PY{o}{=} \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{]} \PY{c+c1}{\PYZsh{} no global constraints}
\PY{c+c1}{\PYZsh{} sub\PYZhy{}system 1 optimization problem}
\PY{n}{f1} \PY{o}{=} \PY{l+m+mi}{0} \PY{c+c1}{\PYZsh{} no local objective}
\PY{n}{g1} \PY{o}{=} \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{]} \PY{c+c1}{\PYZsh{} no local constraints}
\PY{c+c1}{\PYZsh{} sub\PYZhy{}system 2 optimization problem}
\PY{n}{f2} \PY{o}{=} \PY{l+m+mi}{0} \PY{c+c1}{\PYZsh{} no local objective}
\PY{n}{g2} \PY{o}{=} \PY{p}{[}\PY{n}{g21}\PY{p}{,}\PY{p}{]}

\PY{n}{f\PYZus{}local} \PY{o}{=} \PY{p}{[}\PY{n}{f1}\PY{p}{,}\PY{n}{f2}\PY{p}{]}
\PY{n}{g\PYZus{}local} \PY{o}{=} \PY{p}{[}\PY{n}{g1}\PY{p}{,}\PY{n}{g2}\PY{p}{]}
\PY{n}{disciplines} \PY{o}{=} \PY{p}{[}\PY{n}{U1}\PY{p}{,}\PY{n}{U2}\PY{p}{]}

\PY{n}{u0} \PY{o}{=} \PY{l+m+mf}{1.0}\PY{p}{;} \PY{n}{v0} \PY{o}{=} \PY{l+m+mf}{1.0}\PY{p}{;} \PY{n}{w0} \PY{o}{=} \PY{l+m+mf}{1.0}\PY{p}{;} \PY{n}{a0} \PY{o}{=} \PY{l+m+mf}{1.0}\PY{p}{;} \PY{n}{b0} \PY{o}{=} \PY{l+m+mf}{1.0}
\PY{n}{x0\PYZus{}init} \PY{o}{=} \PY{p}{[}\PY{n}{u0}\PY{p}{,}\PY{p}{]} \PY{c+c1}{\PYZsh{} initial guess for shared variable (u)}
\PY{n}{xi\PYZus{}init} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{n}{v0}\PY{p}{,}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{n}{w0}\PY{p}{,}\PY{p}{]}\PY{p}{]} \PY{c+c1}{\PYZsh{} initial guess for local variables (v and w)}
\PY{n}{u\PYZus{}init} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{n}{a0}\PY{p}{,}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{n}{b0}\PY{p}{,}\PY{p}{]}\PY{p}{]} \PY{c+c1}{\PYZsh{} initial guess for state variables (a and b)}

\PY{n}{lbs} \PY{o}{=} \PY{p}{[}\PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{]}\PY{p}{;} \PY{n}{ubs} \PY{o}{=} \PY{p}{[}\PY{l+m+mf}{10.}\PY{p}{,}\PY{p}{]} \PY{c+c1}{\PYZsh{} bounds of shared variable (u)}
\PY{n}{lbi} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{]}\PY{p}{]}\PY{p}{;} \PY{n}{ubi} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{l+m+mf}{10.}\PY{p}{,}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mf}{10.}\PY{p}{,}\PY{p}{]}\PY{p}{]} \PY{c+c1}{\PYZsh{} bounds of local variables (v and w)}
\PY{n}{lbu} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{]}\PY{p}{]}\PY{p}{;} \PY{n}{ubu} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{l+m+mf}{10.}\PY{p}{,}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mf}{10.}\PY{p}{,}\PY{p}{]}\PY{p}{]} \PY{c+c1}{\PYZsh{} bounds of state variables (a and b)}

\PY{n}{opt\PYZus{}options} \PY{o}{=} \PY{p}{\PYZob{}}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{seed}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+m+mi}{0}\PY{p}{,} 
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{budget}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+m+mi}{1000}\PY{p}{,} 
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{tol}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{l+m+mf}{1e\PYZhy{}12}\PY{p}{,} 
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{display}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{k+kc}{False}\PY{p}{,} 
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{opportunistic}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:} \PY{k+kc}{False}
\PY{p}{\PYZcb{}}
\PY{n}{my\PYZus{}atc} \PY{o}{=} \PY{n}{ATC}\PY{p}{(}\PY{n}{disciplines}\PY{o}{=}\PY{n}{disciplines}\PY{p}{,}\PY{n}{f\PYZus{}global}\PY{o}{=}\PY{n}{f\PYZus{}global}\PY{p}{,} 
    \PY{n}{g\PYZus{}global}\PY{o}{=}\PY{n}{g\PYZus{}global}\PY{p}{,}\PY{n}{f\PYZus{}local}\PY{o}{=}\PY{n}{f\PYZus{}local}\PY{p}{,}\PY{n}{g\PYZus{}local}\PY{o}{=}\PY{n}{g\PYZus{}local}\PY{p}{,}\PY{n}{x0\PYZus{}init}\PY{o}{=}\PY{n}{x0\PYZus{}init}\PY{p}{,}
    \PY{n}{xi\PYZus{}init}\PY{o}{=}\PY{n}{xi\PYZus{}init}\PY{p}{,}\PY{n}{u\PYZus{}init}\PY{o}{=}\PY{n}{u\PYZus{}init}\PY{p}{,}\PY{n}{lbs}\PY{o}{=}\PY{n}{lbs}\PY{p}{,}\PY{n}{ubs}\PY{o}{=}\PY{n}{ubs}\PY{p}{,}\PY{n}{lbi}\PY{o}{=}\PY{n}{lbi}\PY{p}{,}\PY{n}{ubi}\PY{o}{=}\PY{n}{ubi}\PY{p}{,}
    \PY{n}{lbu}\PY{o}{=}\PY{n}{lbu}\PY{p}{,}\PY{n}{ubu}\PY{o}{=}\PY{n}{ubu}\PY{p}{,}\PY{n}{opt\PYZus{}options}\PY{o}{=}\PY{n}{opt\PYZus{}options}\PY{p}{,}\PY{n}{w0}\PY{o}{=}\PY{l+m+mf}{1.0}\PY{p}{,}\PY{n}{v0}\PY{o}{=}\PY{l+m+mf}{0.0}\PY{p}{,}
    \PY{n}{beta}\PY{o}{=}\PY{l+m+mf}{1.1}\PY{p}{,}\PY{n}{gamma}\PY{o}{=}\PY{l+m+mf}{0.1}\PY{p}{)}
\PY{n}{x0}\PY{p}{,}\PY{n}{cx0}\PY{p}{,}\PY{n}{xi}\PY{p}{,}\PY{n}{u}\PY{p}{,}\PY{n}{cu}\PY{p}{,}\PY{n}{phi}\PY{p}{,}\PY{n}{f} \PY{o}{=} \PY{n}{my\PYZus{}atc}\PY{o}{.}\PY{n}{run\PYZus{}atc}\PY{p}{(}\PY{n}{k\PYZus{}max}\PY{o}{=}\PY{l+m+mi}{200}\PY{p}{,}\PY{n}{tol}\PY{o}{=}\PY{l+m+mf}{1e\PYZhy{}6}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
ATC terminated
    \end{Verbatim}

    Wow that took a while. This is because two nested optimization problems
were solved as part of the main system-level optimization problem.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{11}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{===========================}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{f\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}f(}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*) = }\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{f}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{f\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} minimum}
\PY{n}{x\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*\PYZdl{} = \PYZdl{}[}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{]\PYZca{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+si}{\PYZob{}T\PYZcb{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{x0}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{xi}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{xi}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{x\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} optimizer}
\PY{n}{u\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{hat}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}u\PYZcb{}}\PY{l+s+s2}{\PYZcb{}(}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*)\PYZdl{} = \PYZdl{}[}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{]\PYZca{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+si}{\PYZob{}T\PYZcb{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{u}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{u\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} state variables}
\PY{n}{c\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}g\PYZcb{}}\PY{l+s+s2}{\PYZus{}c(}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*)\PYZdl{} = \PYZdl{}[}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{\PYZti{}\PYZti{}}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{]\PYZca{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+si}{\PYZob{}T\PYZcb{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{cx0}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{cu}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{cu}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{c\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} inconsistencies}
\PY{n}{g2\PYZus{}tex} \PY{o}{=} \PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}g\PYZcb{}}\PY{l+s+s2}{\PYZus{}2(}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathbf}\PY{l+s+si}{\PYZob{}x\PYZcb{}}\PY{l+s+s2}{\PYZca{}*)\PYZdl{} = \PYZdl{}[}\PY{l+s+si}{\PYZpc{}.4f}\PY{l+s+s2}{]\PYZca{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+si}{\PYZob{}T\PYZcb{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZdq{}} \PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{g21}\PY{p}{(}\PY{n}{x0}\PY{p}{,}\PY{n}{xi}\PY{p}{,}\PY{n}{u}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
\PY{n}{display}\PY{p}{(}\PY{n}{Latex}\PY{p}{(}\PY{n}{g2\PYZus{}tex}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} local constraint}
\PY{c+c1}{\PYZsh{} print(f\PYZus{}tex) \PYZsh{} minimum}
\PY{c+c1}{\PYZsh{} print(x\PYZus{}tex) \PYZsh{} optimizer}
\PY{c+c1}{\PYZsh{} print(u\PYZus{}tex) \PYZsh{} state variables}
\PY{c+c1}{\PYZsh{} print(c\PYZus{}tex) \PYZsh{} inconsistencies}
\PY{c+c1}{\PYZsh{} print(g2\PYZus{}tex) \PYZsh{} local constraint}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
===========================
    \end{Verbatim}

    $f(\mathbf{x}^*) = 7.1078$

    
    $\mathbf{x}^*$ = $[1.0935~~2.4418~~2.4518]^\mathrm{T}$

    
    $\hat{\mathbf{u}}(\mathbf{x}^*)$ = $[1.6406~~1.9319]^\mathrm{T}$

    
    $\mathbf{g}_c(\mathbf{x}^*)$ = $[0.0000~~0.0000~~0.0000]^\mathrm{T}$

    
    $\mathbf{g}_2(\mathbf{x}^*)$ = $[-5.6263]^\mathrm{T}$

    
    We did not do better than IDF or MDF but we managed to reduce the
problem size compared to IDF. We also needed to execute the discipline
analyses \(\mathcal{U}_1\) and \(\mathcal{U_2}\) many more times.
\texttt{ATC} keeps track of how many times each discipline was called.
We can examine this result below.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{12}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{my\PYZus{}atc}\PY{o}{.}\PY{n}{n\PYZus{}evaluations}
\end{Verbatim}
\end{tcolorbox}

            \begin{tcolorbox}[breakable, size=fbox, boxrule=.5pt, pad at break*=1mm, opacityfill=0]
\prompt{Out}{outcolor}{12}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
[7308, 4369, 5865]
\end{Verbatim}
\end{tcolorbox}
        
    The numbers above are quite large. A work around for this is to use
\emph{non-hierarchical analytical target cascading} which does away with
the system-level optimization problem. This means that we need to solve
two optimization problems during each outer loop instead of three. To
understand how the optimization problems are nested let us examine the
XDSM for the above implementation of ATC on our numerical example.

\begin{longtable}[]{@{}c@{}}
\toprule
\endhead
\begin{minipage}[t]{0.97\columnwidth}\centering
    \begin{figure}
        \centering
        \includegraphics[width=0.9\textwidth]{atc.pdf}
    \end{figure}
\end{minipage}\tabularnewline
Fig.10 ATC architecture of the numerical example.\tabularnewline
\bottomrule
\end{longtable}

or more compactly and generally using the XDSM and block diagrams below:

\begin{longtable}[]{@{}c@{}}
    \toprule
    \endhead
    \begin{minipage}[t]{0.97\columnwidth}\centering
        \begin{figure}
            \centering
            \includegraphics[width=0.9\textwidth]{atc_compact.pdf}
        \end{figure}
        \begin{figure}
            \centering
            \includegraphics[width=0.9\textwidth]{images/ATC_diagram.png}
        \end{figure}
    \end{minipage}\tabularnewline
    Fig.11 ATC architecture for a generic problem.\tabularnewline
    \bottomrule
\end{longtable}


    % Add a bibliography block to the postdoc
    
    
    
\end{document}
